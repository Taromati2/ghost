//ERB转dic
//by steve02081504 for Taromati2
//
ERBconver.main:void{//ERBconver.main('Desktop\other\R18\ERA魅魔0.5\ERB\SYSTEM.ERB')
	ERBconver.varinit(_argv[0])
	while ERBconver.line.now!='ERBconver.endflag'{
		{
			if RE_GREP(ERBconver.line.now,'^;')
				ERBconver.line.now=RE_REPLACE(ERBconver.line.now,'^;','//')
			elseif RE_GREP(ERBconver.line.now,'^@'){
				ERBconver.line.now=RE_REPLACE(ERBconver.line.now,'^@','')
				if ERBconver.InFunc{
					ERBconver.line.now='}'+C_LF+ERBconver.line.now
				}
				ERBconver.line.now+='{'
				ERBconver.InFunc=1
			}
			else{
				_req=ERBconver.line.now[0,' ']
				case _req{
					when 'IF'{
						ERBconver.line.now[0,' ']='if'
						ERBconver.line.now+='{'
					}
					when 'ELSEIF'{
						ERBconver.line.now[0,' ']='}elseif'
						ERBconver.line.now+='{'
					}
					when 'ELSE'{
						ERBconver.line.now[0,' ']='}else{'
					}
					when 'SIF'{
						ERBconver.line.now[0,' ']='if'
					}
					when 'SELECTCASE'{
						ERBconver.line.now[0,' ']='case'
						ERBconver.line.now+='{'
						ERBconver.NotFirstCase=0
					}
					when 'CASE'{
						ERBconver.line.now[0,' ']='when'
						if ERBconver.NotFirstCase{
							ERBconver.line.now='}'+C_LF+ERBconver.line.now
						}
						ERBconver.line.now+='{'
						ERBconver.NotFirstCase=1
					}
					when 'CASEELSE'{
						ERBconver.line.now='others{'
						if ERBconver.NotFirstCase{
							ERBconver.line.now='}'+C_LF+ERBconver.line.now
						}
					}
					when 'ENDSELECT'{
						ERBconver.line.now='}'+C_LF+'}'
					}
					when 'FOR'{
						ERBconver.line.now[0,' ']='for'
						ERBconver.line.now+='{'
					}
					when 'ENDIF','NEXT'{
						ERBconver.line.now='}'
					}
					when 'CALL'{
						ERBconver.line.now[0,' ']=IARRAY
						_funcname=ERBconver.line.now[0,',']
						ERBconver.line.now[0,',']=IARRAY
						ERBconver.line.now=RE_REPLACE(ERBconver.line.now,'^\s+','')
						ERBconver.line.now=RE_REPLACE(ERBconver.line.now,'\s+$','')
						ERBconver.line.now=_funcname+'('+ERBconver.line.now+')'
					}
					when 'SWAP'{
						ERBconver.line.now[0,' ']=IARRAY
						_var0name=ERBconver.line.now[0,',']
						_var1name=ERBconver.line.now[1,',']
						ERBconver.line.now="SWAP_VAR('"+_var0name+"','"+_var1name+"')"
					}
					when 'PRINT'{
						ERBconver.line.now[0,' ']=IARRAY
						ERBconver.line.now="SHIORI_FW.Print('"+ERBconver.line.now+"')"
					}
					when 'PRINTFORM'{
						ERBconver.line.now[0,' ']=IARRAY
						ERBconver.line.now=RE_REPLACEEX(ERBconver.line.now,'(\%|\\\@)([\s\S]*?)(\%|\\\@)','%($2)')
						ERBconver.line.now='SHIORI_FW.Print("'+ERBconver.line.now+'")'
					}
					when 'PRINTL','PRINTW'{
						ERBconver.line.now[0,' ']=IARRAY
						ERBconver.line.now="SHIORI_FW.PrintLine('"+ERBconver.line.now+"')"
					}
					when 'PRINTFORMW','PRINTFORML'{
						ERBconver.line.now[0,' ']=IARRAY
						ERBconver.line.now=RE_REPLACEEX(ERBconver.line.now,'(\%|\\\@)([\s\S]*?)(\%|\\\@)','%($2)')
						ERBconver.line.now='SHIORI_FW.PrintLine("'+ERBconver.line.now+'")'
					}
				}
			}
		}
		//
		ERBconver.writeline(ERBconver.line.now)
		//
		ERBconver.readline
	}
	ERBconver.clearvar
}
ERBconver.varinit:void{
	ERBconver.fname=_argv[0]
	ERBconver.tfname=RE_REPLACE(_argv[0],'\.(erb|Erb|ERB)$','')+'.dic'
	FOPEN(ERBconver.fname,'r')
	FOPEN(ERBconver.tfname,'wb')
	ERBconver.line.now='ERBconver.beginflag'
}
ERBconver.clearvar:void{
	FCLOSE(ERBconver.fname)
	FCLOSE(ERBconver.tfname)
	dicforma.main(ERBconver.tfname)
	ERASEVAR('dicforma.radical')
	ERASEALLVARBEGINAS('ERBconver')
}
ERBconver.readline.base{
	if ISFILEEND(ERBconver.fname){
		'ERBconver.endflag'
		return
	}
	_t=FREAD(ERBconver.fname)
	_t=RE_REPLACE(_t,'^\s+','')
	_t=RE_REPLACE(_t,'\s+$','')
	_t
}
ERBconver.readline:void{
	ERBconver.line.now=ERBconver.readline.base
	if ERBconver.line.now=='ERBconver.endflag'
		return
}
ERBconver.writeline:void{
	if _argv[0]=='ERBconver.beginflag'
		return
	if _argv[0]==''{
		FWRITE2(ERBconver.tfname,C_LF)
		return
	}
	_t=_argv[0]
	_argv[0]=IARRAY
	FWRITE_WITH_LF(ERBconver.tfname,_t)
}
